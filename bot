from aiogram import Bot, Dispatcher, types
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton, Message
import asyncio

TOKEN = "8511153040:AAFRLGT9UErVxCLLIlgSjq5qTCTEymf7j5M"   # –≤—Å—Ç–∞–≤—å —Ç–æ–∫–µ–Ω

bot = Bot(token=TOKEN)
dp = Dispatcher()

user_data = {}

def main_keyboard():
    return InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(text="‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–æ—Ç–µ", callback_data="info")],
            [InlineKeyboardButton(text="üöÄ –ü—Ä–∏—Å—Ç—É–ø–∏—Ç—å –∫ –∑–∞–¥–∞–Ω–∏—è–º", callback_data="tasks_menu")]
        ]
    )

def tasks_keyboard():
    return InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(text="üü¢ –õ—ë–≥–∫–∏–µ –∑–∞–¥–∞–Ω–∏—è", callback_data="level_easy")],
            [InlineKeyboardButton(text="üü° –°—Ä–µ–¥–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è", callback_data="level_medium")],
            [InlineKeyboardButton(text="üî¥ –°–ª–æ–∂–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è", callback_data="level_hard")],
            [InlineKeyboardButton(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="back_to_menu")]
        ]
    )

def back_button():
    return InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="back_to_menu")]
        ]
    )

TASKS = {
    "easy": {"question": "–°–∫–æ–ª—å–∫–æ –±—É–¥–µ—Ç 2 + 2?", "answer": "4"},
    "medium": {"question": "–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è —è–∑—ã–∫, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –Ω–∞–ø–∏—Å–∞–Ω —ç—Ç–æ—Ç –±–æ—Ç?", "answer": "python"},
    "hard": {"question": "–°–∫–æ–ª—å–∫–æ –±—É–∫–≤ –≤ —Å–ª–æ–≤–µ '–∫–∞–ª–∏–±—Ä'?", "answer": "6"}
}

@dp.message()
async def start(message: Message):
    user_id = message.from_user.id
    if user_id not in user_data:
        user_data[user_id] = {"points": 0, "level": None}
    await message.answer(
        "üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ *55caliber Bot*!\n–í—ã–±–µ—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=main_keyboard(),
        parse_mode="Markdown"
    )

@dp.callback_query(lambda c: c.data == "info")
async def info_handler(callback: types.CallbackQuery):
    await callback.message.answer(
        "üìå *55caliber ‚Äî –∏–Ω—Ñ–∞ –æ –±–æ—Ç–µ*\n\n–ù—É —Ç–∏–ø–∞ –∏–Ω—Ñ–∞ –æ –±–æ—Ç–µ.",
        reply_markup=back_button(),
        parse_mode="Markdown"
    )
    await callback.answer()

@dp.callback_query(lambda c: c.data == "tasks_menu")
async def tasks_menu(callback: types.CallbackQuery):
    await callback.message.answer("üî• –í—ã–±–µ—Ä–∏ —É—Ä–æ–≤–µ–Ω—å –∑–∞–¥–∞–Ω–∏–π:", reply_markup=tasks_keyboard())
    await callback.answer()

@dp.callback_query(lambda c: c.data.startswith("level_"))
async def choose_level(callback: types.CallbackQuery):
    user_id = callback.from_user.id
    level = callback.data.split("_")[1]
    user_data[user_id]["level"] = level
    question = TASKS[level]["question"]

    await callback.message.answer(
        f"üìù *–ó–∞–¥–∞–Ω–∏–µ ({level}):*\n\n{question}\n\n–ù–∞–ø–∏—à–∏ –æ—Ç–≤–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ–º:",
        parse_mode="Markdown"
    )
    await callback.answer()

@dp.message()
async def answer_handler(message: Message):
    user_id = message.from_user.id
    if user_id not in user_data:
        return

    level = user_data[user_id].get("level")
    if not level:
        await message.answer("–í—ã–±–µ—Ä–∏ —É—Ä–æ–≤–µ–Ω—å –∑–∞–¥–∞–Ω–∏–π!", reply_markup=tasks_keyboard())
        return

    correct_answer = TASKS[level]["answer"].lower().strip()
    user_answer = message.text.lower().strip()

    if user_answer == correct_answer:
        user_data[user_id]["points"] += 10
        await message.answer(
            f"‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ!\n–ë–∞–ª–ª—ã: *{user_data[user_id]['points']}*",
            parse_mode="Markdown",
            reply_markup=tasks_keyboard()
        )
    else:
        await message.answer(
            f"‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: *{correct_answer}*",
            parse_mode="Markdown",
            reply_markup=tasks_keyboard()
        )

@dp.callback_query(lambda c: c.data == "back_to_menu")
async def back(callback: types.CallbackQuery):
    await callback.message.answer("–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é:", reply_markup=main_keyboard())
    await callback.answer()

async def main():
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
